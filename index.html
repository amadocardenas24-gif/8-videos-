<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Tropical - 7 Marcadores</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            font-family: 'Arial', sans-serif;
            background: #000;
        }

        /* Pantallas */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }

        .screen-content {
            background: rgba(0, 0, 0, 0.85);
            border: 3px solid #00b894;
            border-radius: 20px;
            padding: 40px;
            max-width: 90%;
            color: white;
            text-align: center;
        }

        .screen-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #00b894;
        }

        .screen-text {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .btn {
            background: #00b894;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn:hover {
            background: #00a085;
            transform: scale(1.05);
        }

        .loading-bar {
            width: 300px;
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
            margin: 30px auto;
        }

        .loading-progress {
            height: 100%;
            width: 0%;
            background: #00b894;
            transition: width 0.3s;
        }

        /* Controles */
        .controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 1001;
            display: none;
        }

        .control-btn {
            background: rgba(0, 184, 148, 0.9);
            color: white;
            border: 2px solid white;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
        }

        /* Escena AR */
        #ar-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
        }

        /* Video overlay */
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .close-video {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 71, 87, 0.9);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Estado */
        .status {
            position: fixed;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 1002;
            display: none;
        }

        .status-box {
            background: rgba(0, 184, 148, 0.9);
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            display: inline-block;
            font-weight: bold;
            border: 2px solid white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .screen-title {
                font-size: 2rem;
            }
            
            .screen-text {
                font-size: 1rem;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            
            .control-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .loading-bar {
                width: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de inicio -->
    <div class="screen" id="startScreen">
        <div class="screen-content">
            <h1 class="screen-title">üå¥ AR TROPICAL</h1>
            <div class="screen-text">
                Experiencia de Realidad Aumentada<br>
                7 marcadores diferentes
            </div>
            <button class="btn" id="startBtn">
                INICIAR EXPERIENCIA
            </button>
        </div>
    </div>

    <!-- Pantalla de permisos -->
    <div class="screen" id="permissionScreen" style="display: none;">
        <div class="screen-content">
            <h1 class="screen-title">üì∏ Permiso de C√°mara</h1>
            <div class="screen-text">
                Para activar la realidad aumentada necesitamos acceso a tu c√°mara.<br><br>
                <strong>Importante:</strong> Solo usamos la c√°mara para detectar los marcadores.<br>
                No grabamos ni almacenamos video.
            </div>
            <button class="btn" id="permissionBtn">
                PERMITIR C√ÅMARA
            </button>
            <div style="margin-top: 20px; font-size: 0.9rem; color: #ccc;">
                Si el permiso no aparece, recarga la p√°gina
            </div>
        </div>
    </div>

    <!-- Pantalla de carga -->
    <div class="screen" id="loadingScreen" style="display: none;">
        <div class="screen-content">
            <h1 class="screen-title">CARGANDO</h1>
            <div class="loading-bar">
                <div class="loading-progress" id="loadingProgress"></div>
            </div>
            <div class="screen-text" id="loadingMessage">
                Iniciando sistema AR...
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="controls" id="controls">
        <button class="control-btn" id="soundBtn">
            <span id="soundIcon">üîá</span>
            <span id="soundText">SONIDO OFF</span>
        </button>
        <button class="control-btn" id="restartBtn">
            <span>üîÑ</span>
            <span>REINICIAR</span>
        </button>
    </div>

    <!-- Estado -->
    <div class="status" id="status">
        <div class="status-box">
            üì± Escanea un marcador (1-7)
        </div>
    </div>

    <!-- Video overlay -->
    <div class="video-overlay" id="videoOverlay">
        <div class="video-container">
            <video id="overlayVideo" loop playsinline webkit-playsinline></video>
            <button class="close-video" id="closeVideoBtn">‚úï CERRAR</button>
        </div>
    </div>

    <!-- Escena AR -->
    <div id="ar-scene"></div>

    <script>
        // =================== CONFIGURACI√ìN ===================
        let isMuted = true;
        let currentMarkerIndex = null;
        let markerVideos = [];
        let cameraStream = null;
        
        // Lista de 7 videos - CAMBIA ESTAS RUTAS SEG√öN TUS ARCHIVOS
        // Si est√°n en la misma carpeta que index.html:
        const videoSources = [
            'video1.mp4',
            'video2.mp4', 
            'video3.mp4',
            'video4.mp4',
            'video5.mp4',
            'video6.mp4',
            'video7.mp4'
        ];
        
        // Si est√°n en una carpeta llamada "videos":
        // const videoSources = [
        //     'videos/video1.mp4',
        //     'videos/video2.mp4',
        //     ...
        // ];
        
        // Nombres de los marcadores
        const markerNames = [
            "Marcador 1", "Marcador 2", "Marcador 3", "Marcador 4",
            "Marcador 5", "Marcador 6", "Marcador 7"
        ];
        
        // =================== INICIALIZACI√ìN ===================
        document.addEventListener('DOMContentLoaded', () => {
            console.log("AR Tropical - Iniciando...");
            
            // Bot√≥n de inicio
            document.getElementById('startBtn').addEventListener('click', () => {
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('permissionScreen').style.display = 'flex';
            });
            
            // Bot√≥n de permisos
            document.getElementById('permissionBtn').addEventListener('click', requestCameraPermission);
            
            // Bot√≥n de sonido
            document.getElementById('soundBtn').addEventListener('click', toggleSound);
            
            // Bot√≥n de reinicio
            document.getElementById('restartBtn').addEventListener('click', restartExperience);
            
            // Bot√≥n para cerrar video
            document.getElementById('closeVideoBtn').addEventListener('click', () => {
                document.getElementById('videoOverlay').style.display = 'none';
                const video = document.getElementById('overlayVideo');
                if (video) video.pause();
            });
        });
        
        // =================== PERMISOS DE C√ÅMARA ===================
        async function requestCameraPermission() {
            const permissionBtn = document.getElementById('permissionBtn');
            
            permissionBtn.textContent = "SOLICITANDO...";
            permissionBtn.disabled = true;
            
            try {
                // Configuraci√≥n simple de c√°mara
                const constraints = {
                    video: {
                        facingMode: 'environment', // Usar c√°mara trasera
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };
                
                // Solicitar acceso a la c√°mara
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Guardar el stream
                cameraStream = stream;
                
                // Detener el stream (solo necesitamos el permiso)
                stream.getTracks().forEach(track => track.stop());
                
                permissionBtn.textContent = "¬°PERMITIDO!";
                permissionBtn.style.background = "#0984e3";
                
                // Iniciar carga
                setTimeout(startLoading, 500);
                
            } catch (error) {
                console.error("Error de c√°mara:", error);
                
                let errorMsg = "No se pudo acceder a la c√°mara. ";
                
                if (error.name === 'NotAllowedError') {
                    errorMsg = "Permiso denegado. Haz clic en 'Permitir' cuando el navegador lo solicite.";
                } else if (error.name === 'NotFoundError') {
                    errorMsg = "No se encontr√≥ c√°mara en tu dispositivo.";
                } else {
                    errorMsg += error.message;
                }
                
                alert(errorMsg);
                
                permissionBtn.textContent = "REINTENTAR";
                permissionBtn.disabled = false;
                permissionBtn.style.background = "#ff7675";
            }
        }
        
        // =================== CARGA ===================
        function startLoading() {
            document.getElementById('permissionScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'flex';
            
            // Iniciar carga progresiva
            simulateLoading();
        }
        
        function simulateLoading() {
            let progress = 0;
            const progressBar = document.getElementById('loadingProgress');
            const loadingMessage = document.getElementById('loadingMessage');
            
            const interval = setInterval(() => {
                progress += 2;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                
                // Mensajes seg√∫n progreso
                if (progress < 20) {
                    loadingMessage.textContent = "Verificando recursos...";
                } else if (progress < 40) {
                    loadingMessage.textContent = "Cargando videos...";
                } else if (progress < 60) {
                    loadingMessage.textContent = "Preparando marcadores...";
                } else if (progress < 80) {
                    loadingMessage.textContent = "Iniciando c√°mara...";
                } else {
                    loadingMessage.textContent = "¬°Listo!";
                }
                
                // Cuando llegue al 100%
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(initARScene, 500);
                }
            }, 30);
        }
        
        // =================== ESCENA AR ===================
        function initARScene() {
            console.log("Creando escena AR...");
            
            // Ocultar pantalla de carga
            document.getElementById('loadingScreen').style.display = 'none';
            
            // Crear escena AR con 7 marcadores
            createARScene();
            
            // Mostrar escena despu√©s de un breve retraso
            setTimeout(() => {
                document.getElementById('ar-scene').style.display = 'block';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('status').style.display = 'block';
                
                // Configurar eventos
                setTimeout(setupAREvents, 1000);
            }, 500);
        }
        
        function createARScene() {
            let assetsHTML = '';
            let targetsHTML = '';
            
            // Crear 7 videos y 7 marcadores
            for (let i = 0; i < 7; i++) {
                // Asset de video
                assetsHTML += `
                    <video 
                        id="ar-video${i}" 
                        src="${videoSources[i]}" 
                        preload="auto"
                        loop 
                        playsinline 
                        webkit-playsinline
                        crossorigin="anonymous"
                        muted
                    ></video>
                `;
                
                // Marcador AR
                targetsHTML += `
                    <a-entity 
                        id="ar-target${i}" 
                        mindar-image-target="targetIndex: ${i}"
                    >
                        <a-plane
                            src="#ar-video${i}"
                            position="0 0 0"
                            rotation="0 0 0"
                            height="0.75"
                            width="1"
                            material="side: double; shader: flat"
                        ></a-plane>
                    </a-entity>
                `;
            }
            
            // Escena completa
            const arSceneHTML = `
                <a-scene 
                    mindar-image="imageTargetSrc: ./marker.mind; autoStart: true; maxTrack: 1; uiScanning: no; uiLoading: no; uiError: no;" 
                    vr-mode-ui="enabled: false"
                    device-orientation-permission-ui="enabled: false"
                    embedded
                    loading-screen="enabled: false"
                    renderer="colorManagement: true; precision: mediump; alpha: true"
                >
                    <a-assets>
                        ${assetsHTML}
                    </a-assets>
                    
                    <a-camera 
                        position="0 0 0" 
                        look-controls="enabled: true"
                        wasd-controls="enabled: false"
                    ></a-camera>
                    
                    ${targetsHTML}
                    
                    <!-- Luz -->
                    <a-light type="ambient" color="#FFFFFF" intensity="0.8"></a-light>
                    <a-light type="directional" position="0 5 5" intensity="0.5"></a-light>
                </a-scene>
            `;
            
            document.getElementById('ar-scene').innerHTML = arSceneHTML;
        }
        
        // =================== EVENTOS AR ===================
        function setupAREvents() {
            console.log("Configurando eventos AR...");
            
            // Obtener videos AR
            markerVideos = [];
            for (let i = 0; i < 7; i++) {
                const video = document.querySelector(`#ar-video${i}`);
                if (video) {
                    markerVideos.push(video);
                    setupVideoEvents(video, i);
                }
            }
            
            // Configurar marcadores
            for (let i = 0; i < 7; i++) {
                const marker = document.querySelector(`#ar-target${i}`);
                if (marker) {
                    setupMarkerEvents(marker, i);
                }
            }
            
            // Configurar overlay
            setupOverlayVideo();
            
            console.log("Eventos configurados");
        }
        
        function setupVideoEvents(video, index) {
            video.addEventListener('loadeddata', () => {
                console.log(`Video ${index+1} cargado`);
            });
            
            video.addEventListener('error', () => {
                console.error(`Error cargando video ${index+1}`);
            });
            
            video.addEventListener('ended', () => {
                video.currentTime = 0;
                video.play();
            });
        }
        
        function setupMarkerEvents(marker, index) {
            // Cuando se detecta el marcador
            marker.addEventListener('targetFound', () => {
                console.log(`Marcador ${index+1} detectado`);
                currentMarkerIndex = index;
                
                // Ocultar overlay
                document.getElementById('videoOverlay').style.display = 'none';
                const overlayVideo = document.getElementById('overlayVideo');
                if (overlayVideo) overlayVideo.pause();
                
                // Reproducir video
                if (markerVideos[index]) {
                    const video = markerVideos[index];
                    video.muted = isMuted;
                    video.currentTime = 0;
                    video.play().catch(() => {
                        video.muted = true;
                        video.play();
                    });
                }
                
                // Actualizar estado
                document.getElementById('status').innerHTML = `
                    <div class="status-box">
                        üé¨ ${markerNames[index]}
                    </div>
                `;
            });
            
            // Cuando se pierde el marcador
            marker.addEventListener('targetLost', () => {
                console.log(`Marcador ${index+1} perdido`);
                
                // Pausar video AR
                if (markerVideos[index]) {
                    const currentTime = markerVideos[index].currentTime;
                    markerVideos[index].pause();
                    
                    // Mostrar en overlay si estaba reproduciendo
                    if (currentTime > 0) {
                        showVideoInOverlay(index, currentTime);
                    }
                }
                
                // Restaurar estado
                setTimeout(() => {
                    document.getElementById('status').innerHTML = `
                        <div class="status-box">
                            üì± Escanea un marcador (1-7)
                        </div>
                    `;
                }, 100);
            });
        }
        
        function showVideoInOverlay(index, currentTime) {
            const overlayVideo = document.getElementById('overlayVideo');
            
            // Configurar overlay
            overlayVideo.src = videoSources[index];
            overlayVideo.currentTime = currentTime;
            overlayVideo.muted = isMuted;
            overlayVideo.loop = true;
            
            // Mostrar overlay
            document.getElementById('videoOverlay').style.display = 'flex';
            
            // Reproducir
            overlayVideo.play().catch(() => {
                overlayVideo.muted = true;
                overlayVideo.play();
            });
        }
        
        function setupOverlayVideo() {
            const overlayVideo = document.getElementById('overlayVideo');
            
            overlayVideo.addEventListener('ended', function() {
                this.currentTime = 0;
                this.play();
            });
            
            // Cerrar al hacer clic fuera
            document.getElementById('videoOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    overlayVideo.pause();
                }
            });
        }
        
        // =================== CONTROLES ===================
        function toggleSound() {
            isMuted = !isMuted;
            const soundIcon = document.getElementById('soundIcon');
            const soundText = document.getElementById('soundText');
            
            // Actualizar videos AR
            markerVideos.forEach(video => {
                if (video) video.muted = isMuted;
            });
            
            // Actualizar overlay
            const overlayVideo = document.getElementById('overlayVideo');
            if (overlayVideo) overlayVideo.muted = isMuted;
            
            // Actualizar bot√≥n
            if (isMuted) {
                soundIcon.textContent = 'üîá';
                soundText.textContent = 'SONIDO OFF';
            } else {
                soundIcon.textContent = 'üîä';
                soundText.textContent = 'SONIDO ON';
            }
        }
        
        function restartExperience() {
            // Pausar videos
            markerVideos.forEach(video => {
                if (video) video.pause();
            });
            
            const overlayVideo = document.getElementById('overlayVideo');
            if (overlayVideo) overlayVideo.pause();
            
            // Detener c√°mara
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Ocultar elementos
            document.getElementById('ar-scene').style.display = 'none';
            document.getElementById('videoOverlay').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            
            // Limpiar escena
            document.getElementById('ar-scene').innerHTML = '';
            
            // Resetear estado
            isMuted = true;
            markerVideos = [];
            
            // Actualizar bot√≥n de sonido
            document.getElementById('soundIcon').textContent = 'üîá';
            document.getElementById('soundText').textContent = 'SONIDO OFF';
            
            // Mostrar inicio
            document.getElementById('startScreen').style.display = 'flex';
        }
    </script>
</body>
</html>
