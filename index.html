<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Tropical - 7 Marcadores</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            font-family: 'Arial', sans-serif;
            background: #000;
        }

        /* Pantalla de inicio */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }

        .screen-content {
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #00b894;
            border-radius: 20px;
            padding: 40px;
            max-width: 90%;
            color: white;
            text-align: center;
        }

        .screen-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #00b894;
        }

        .screen-text {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .btn {
            background: #00b894;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn:hover {
            background: #00a085;
            transform: scale(1.05);
        }

        .loading-bar {
            width: 300px;
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
            margin: 30px auto;
        }

        .loading-progress {
            height: 100%;
            width: 0%;
            background: #00b894;
            transition: width 0.3s;
        }

        /* Controles */
        .controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 1001;
            display: none;
        }

        .control-btn {
            background: rgba(0, 184, 148, 0.9);
            color: white;
            border: 2px solid white;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
        }

        /* Escena AR */
        #ar-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
        }

        /* Video overlay */
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .close-video {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 71, 87, 0.9);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Estado */
        .status {
            position: fixed;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 1002;
            display: none;
        }

        .status-box {
            background: rgba(0, 184, 148, 0.9);
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            display: inline-block;
            font-weight: bold;
            border: 2px solid white;
        }

        @media (max-width: 768px) {
            .screen-title {
                font-size: 2rem;
            }
            
            .screen-text {
                font-size: 1rem;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            
            .control-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .loading-bar {
                width: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de inicio -->
    <div class="screen" id="startScreen">
        <div class="screen-content">
            <h1 class="screen-title">üå¥ AR TROPICAL</h1>
            <div class="screen-text">
                Experiencia de Realidad Aumentada<br>
                7 marcadores diferentes
            </div>
            <button class="btn" id="startBtn">
                INICIAR EXPERIENCIA
            </button>
        </div>
    </div>

    <!-- Pantalla de permisos -->
    <div class="screen" id="permissionScreen" style="display: none;">
        <div class="screen-content">
            <h1 class="screen-title">üì∏ Permiso de C√°mara</h1>
            <div class="screen-text">
                Para activar la realidad aumentada necesitamos acceso a tu c√°mara.<br><br>
                <strong>Importante:</strong> Solo usamos la c√°mara para detectar los marcadores.<br>
                No grabamos ni almacenamos video.
            </div>
            <button class="btn" id="permissionBtn">
                PERMITIR C√ÅMARA
            </button>
        </div>
    </div>

    <!-- Pantalla de carga -->
    <div class="screen" id="loadingScreen" style="display: none;">
        <div class="screen-content">
            <h1 class="screen-title">CARGANDO</h1>
            <div class="loading-bar">
                <div class="loading-progress" id="loadingProgress"></div>
            </div>
            <div class="screen-text" id="loadingMessage">
                Iniciando sistema AR...
            </div>
        </div>
    </div>

    <!-- Controles -->
    <div class="controls" id="controls">
        <button class="control-btn" id="soundBtn">
            <span id="soundIcon">üîá</span>
            <span id="soundText">SONIDO OFF</span>
        </button>
        <button class="control-btn" id="restartBtn">
            <span>üîÑ</span>
            <span>REINICIAR</span>
        </button>
    </div>

    <!-- Estado -->
    <div class="status" id="status">
        <div class="status-box">
            üì± Escanea un marcador (1-7)
        </div>
    </div>

    <!-- Video overlay -->
    <div class="video-overlay" id="videoOverlay">
        <div class="video-container">
            <video id="overlayVideo" loop playsinline webkit-playsinline></video>
            <button class="close-video" id="closeVideoBtn">‚úï CERRAR</button>
        </div>
    </div>

    <!-- Escena AR -->
    <div id="ar-scene"></div>

    <script>
        // =================== CONFIGURACI√ìN ===================
        let isMuted = true;
        let currentMarkerIndex = null;
        let markerVideos = [];
        let cameraStream = null;
        
        // Lista de 7 videos - AJUSTA ESTAS RUTAS
        const videoSources = [
            'video1.mp4',
            'video2.mp4', 
            'video3.mp4',
            'video4.mp4',
            'video5.mp4',
            'video6.mp4',
            'video7.mp4'
        ];
        
        // =================== INICIALIZACI√ìN ===================
        document.addEventListener('DOMContentLoaded', () => {
            console.log("AR Tropical - Iniciando...");
            
            document.getElementById('startBtn').addEventListener('click', () => {
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('permissionScreen').style.display = 'flex';
            });
            
            document.getElementById('permissionBtn').addEventListener('click', requestCameraPermission);
            document.getElementById('soundBtn').addEventListener('click', toggleSound);
            document.getElementById('restartBtn').addEventListener('click', restartExperience);
            
            document.getElementById('closeVideoBtn').addEventListener('click', () => {
                document.getElementById('videoOverlay').style.display = 'none';
                const video = document.getElementById('overlayVideo');
                if (video) video.pause();
            });
        });
        
        // =================== PERMISOS DE C√ÅMARA ===================
        async function requestCameraPermission() {
            const permissionBtn = document.getElementById('permissionBtn');
            
            permissionBtn.textContent = "SOLICITANDO...";
            permissionBtn.disabled = true;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                cameraStream = stream;
                stream.getTracks().forEach(track => track.stop());
                
                permissionBtn.textContent = "¬°PERMITIDO!";
                permissionBtn.style.background = "#0984e3";
                
                setTimeout(startLoading, 500);
                
            } catch (error) {
                console.error("Error de c√°mara:", error);
                
                let errorMsg = "No se pudo acceder a la c√°mara. ";
                if (error.name === 'NotAllowedError') {
                    errorMsg = "Permiso denegado. Haz clic en 'Permitir' cuando el navegador lo solicite.";
                }
                
                alert(errorMsg);
                
                permissionBtn.textContent = "REINTENTAR";
                permissionBtn.disabled = false;
                permissionBtn.style.background = "#ff7675";
            }
        }
        
        // =================== CARGA ===================
        function startLoading() {
            document.getElementById('permissionScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'flex';
            
            simulateLoading();
        }
        
        function simulateLoading() {
            let progress = 0;
            const progressBar = document.getElementById('loadingProgress');
            const loadingMessage = document.getElementById('loadingMessage');
            
            const interval = setInterval(() => {
                progress += 2;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                
                if (progress < 20) loadingMessage.textContent = "Verificando recursos...";
                else if (progress < 40) loadingMessage.textContent = "Cargando videos...";
                else if (progress < 60) loadingMessage.textContent = "Preparando marcadores...";
                else if (progress < 80) loadingMessage.textContent = "Iniciando c√°mara...";
                else loadingMessage.textContent = "¬°Listo!";
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(initARScene, 500);
                }
            }, 30);
        }
        
        // =================== ESCENA AR ===================
        function initARScene() {
            console.log("Creando escena AR...");
            
            document.getElementById('loadingScreen').style.display = 'none';
            
            // CORRECCI√ìN: Material simplificado para mostrar videos
            let assetsHTML = '';
            let targetsHTML = '';
            
            for (let i = 0; i < 7; i++) {
                assetsHTML += `
                    <video 
                        id="ar-video${i}" 
                        src="${videoSources[i]}" 
                        preload="auto"
                        loop 
                        playsinline 
                        webkit-playsinline
                        crossorigin="anonymous"
                        muted
                    ></video>
                `;
                
                // SOLUCI√ìN PARA VIDEOS INVISIBLES
                targetsHTML += `
                    <a-entity 
                        id="ar-target${i}" 
                        mindar-image-target="targetIndex: ${i}"
                    >
                        <a-plane
                            src="#ar-video${i}"
                            position="0 0 0"
                            rotation="-90 0 0"
                            height="0.75"
                            width="1"
                            material="shader: flat; side: double; transparent: false"
                        ></a-plane>
                    </a-entity>
                `;
            }
            
            const arSceneHTML = `
                <a-scene 
                    mindar-image="imageTargetSrc: ./marker.mind; autoStart: true; maxTrack: 2; uiScanning: no; uiLoading: no; uiError: no;" 
                    vr-mode-ui="enabled: false"
                    device-orientation-permission-ui="enabled: false"
                    embedded
                    loading-screen="enabled: false"
                    renderer="colorManagement: true; alpha: false; antialias: true; precision: high"
                >
                    <a-assets>
                        ${assetsHTML}
                    </a-assets>
                    
                    <a-camera 
                        position="0 0 0" 
                        look-controls="enabled: true"
                        wasd-controls="enabled: false"
                    ></a-camera>
                    
                    ${targetsHTML}
                    
                    <a-light type="ambient" color="#FFFFFF" intensity="1.0"></a-light>
                    <a-light type="directional" position="0 5 5" intensity="0.8" castShadow></a-light>
                </a-scene>
            `;
            
            document.getElementById('ar-scene').innerHTML = arSceneHTML;
            
            setTimeout(() => {
                document.getElementById('ar-scene').style.display = 'block';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('status').style.display = 'block';
                
                setTimeout(setupAREvents, 1500);
            }, 500);
        }
        
        // =================== EVENTOS AR ===================
        function setupAREvents() {
            console.log("Configurando eventos AR...");
            
            // Precargar videos con eventos mejorados
            markerVideos = [];
            const videoPromises = [];
            
            for (let i = 0; i < 7; i++) {
                const video = document.querySelector(`#ar-video${i}`);
                if (video) {
                    markerVideos.push(video);
                    
                    // Configurar eventos del video
                    setupVideoEvents(video, i);
                    
                    const promise = new Promise((resolve) => {
                        const onLoaded = () => {
                            console.log(`‚úÖ Video ${i+1} cargado: ${video.videoWidth}x${video.videoHeight}`);
                            video.removeEventListener('loadeddata', onLoaded);
                            resolve();
                        };
                        
                        const onError = () => {
                            console.error(`‚ùå Error cargando video ${i+1}: ${videoSources[i]}`);
                            video.removeEventListener('error', onError);
                            resolve(); // Continuar aunque falle
                        };
                        
                        video.addEventListener('loadeddata', onLoaded);
                        video.addEventListener('error', onError);
                        
                        // Forzar carga si no se ha cargado
                        if (video.readyState < 2) {
                            video.load();
                        } else {
                            resolve();
                        }
                    });
                    
                    videoPromises.push(promise);
                }
            }
            
            // Cuando todos los videos est√©n listos
            Promise.all(videoPromises).then(() => {
                console.log("Todos los videos procesados");
                
                // Configurar marcadores
                for (let i = 0; i < 7; i++) {
                    const marker = document.querySelector(`#ar-target${i}`);
                    if (marker) {
                        setupMarkerEvents(marker, i);
                    }
                }
                
                setupOverlayVideo();
            });
        }
        
        function setupVideoEvents(video, index) {
            video.addEventListener('loadeddata', () => {
                console.log(`Video ${index+1} dimensiones: ${video.videoWidth}x${video.videoHeight}`);
                
                // Forzar actualizaci√≥n del material
                setTimeout(() => {
                    const plane = document.querySelector(`#ar-target${index} a-plane`);
                    if (plane) {
                        plane.setAttribute('material', 'src', `#ar-video${index}`);
                    }
                }, 100);
            });
            
            video.addEventListener('error', (e) => {
                console.error(`Error en video ${index+1}:`, e);
                console.log(`Ruta del video: ${videoSources[index]}`);
            });
            
            video.addEventListener('canplay', () => {
                console.log(`Video ${index+1} listo para reproducir`);
            });
            
            // Loop autom√°tico
            video.addEventListener('ended', () => {
                video.currentTime = 0;
                video.play().catch(e => {
                    console.log(`Error en loop video ${index+1}:`, e);
                });
            });
        }
        
        function setupMarkerEvents(marker, index) {
            // Cuando se detecta el marcador
            marker.addEventListener('targetFound', () => {
                console.log(`üéØ Marcador ${index+1} detectado`);
                currentMarkerIndex = index;
                
                // Ocultar overlay
                document.getElementById('videoOverlay').style.display = 'none';
                const overlayVideo = document.getElementById('overlayVideo');
                if (overlayVideo) overlayVideo.pause();
                
                // Reproducir video AR
                if (markerVideos[index]) {
                    const video = markerVideos[index];
                    
                    // Asegurar que el video est√© visible
                    const plane = marker.querySelector('a-plane');
                    if (plane) {
                        // Forzar actualizaci√≥n del material
                        plane.setAttribute('material', 'src', `#ar-video${index}`);
                        plane.setAttribute('material', 'opacity', 1);
                        plane.setAttribute('material', 'transparent', false);
                    }
                    
                    // Configurar y reproducir
                    video.muted = isMuted;
                    video.currentTime = 0;
                    
                    // Intentar reproducir con manejo de errores
                    const playVideo = () => {
                        video.play().then(() => {
                            console.log(`‚ñ∂Ô∏è Video ${index+1} reproduci√©ndose`);
                        }).catch(error => {
                            console.warn(`‚ö†Ô∏è Autoplay bloqueado video ${index+1}:`, error);
                            // Silenciar y reintentar
                            video.muted = true;
                            video.play().catch(e => {
                                console.error(`‚ùå Error grave video ${index+1}:`, e);
                            });
                        });
                    };
                    
                    // Peque√±o delay para asegurar que el DOM est√© actualizado
                    setTimeout(playVideo, 100);
                }
                
                // Actualizar estado
                document.getElementById('status').innerHTML = `
                    <div class="status-box">
                        üé¨ Marcador ${index+1}
                    </div>
                `;
            });
            
            // Cuando se pierde el marcador
            marker.addEventListener('targetLost', () => {
                console.log(`Marcador ${index+1} perdido`);
                
                if (markerVideos[index]) {
                    const currentTime = markerVideos[index].currentTime;
                    markerVideos[index].pause();
                    
                    // Mostrar en overlay si estaba reproduciendo
                    if (currentTime > 0 && markerVideos[index].duration > 0) {
                        showVideoInOverlay(index, currentTime);
                    }
                }
                
                // Restaurar estado
                setTimeout(() => {
                    if (!document.querySelector(`#ar-target${index}`)?.getAttribute('visible')) {
                        document.getElementById('status').innerHTML = `
                            <div class="status-box">
                                üì± Escanea un marcador (1-7)
                            </div>
                        `;
                    }
                }, 100);
            });
        }
        
        function showVideoInOverlay(index, currentTime) {
            console.log(`Mostrando video ${index+1} en overlay`);
            
            const overlayVideo = document.getElementById('overlayVideo');
            
            // Configurar overlay
            overlayVideo.src = videoSources[index];
            overlayVideo.currentTime = currentTime || 0;
            overlayVideo.muted = isMuted;
            overlayVideo.loop = true;
            
            // Mostrar overlay
            document.getElementById('videoOverlay').style.display = 'flex';
            
            // Reproducir
            overlayVideo.play().catch(error => {
                console.warn("Autoplay overlay bloqueado:", error);
                overlayVideo.muted = true;
                overlayVideo.play().catch(e => {
                    console.error("Error grave overlay:", e);
                });
            });
        }
        
        function setupOverlayVideo() {
            const overlayVideo = document.getElementById('overlayVideo');
            
            overlayVideo.addEventListener('ended', function() {
                this.currentTime = 0;
                this.play();
            });
            
            overlayVideo.addEventListener('error', function(e) {
                console.error("Error en overlay video:", e);
            });
            
            // Click en overlay para cerrar
            document.getElementById('videoOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    overlayVideo.pause();
                }
            });
        }
        
        // =================== CONTROLES ===================
        function toggleSound() {
            isMuted = !isMuted;
            const soundIcon = document.getElementById('soundIcon');
            const soundText = document.getElementById('soundText');
            
            console.log(`Sonido: ${isMuted ? 'OFF' : 'ON'}`);
            
            // Actualizar todos los videos AR
            markerVideos.forEach(video => {
                if (video) video.muted = isMuted;
            });
            
            // Actualizar overlay
            const overlayVideo = document.getElementById('overlayVideo');
            if (overlayVideo) overlayVideo.muted = isMuted;
            
            // Actualizar bot√≥n
            if (isMuted) {
                soundIcon.textContent = 'üîá';
                soundText.textContent = 'SONIDO OFF';
            } else {
                soundIcon.textContent = 'üîä';
                soundText.textContent = 'SONIDO ON';
            }
        }
        
        function restartExperience() {
            console.log("Reiniciando experiencia...");
            
            // Pausar todos los videos
            markerVideos.forEach(video => {
                if (video) video.pause();
            });
            
            const overlayVideo = document.getElementById('overlayVideo');
            if (overlayVideo) overlayVideo.pause();
            
            // Detener c√°mara
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Ocultar elementos
            document.getElementById('ar-scene').style.display = 'none';
            document.getElementById('videoOverlay').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            
            // Limpiar escena
            document.getElementById('ar-scene').innerHTML = '';
            
            // Resetear
            isMuted = true;
            currentMarkerIndex = null;
            markerVideos = [];
            
            // Actualizar bot√≥n de sonido
            document.getElementById('soundIcon').textContent = 'üîá';
            document.getElementById('soundText').textContent = 'SONIDO OFF';
            
            // Mostrar inicio
            document.getElementById('startScreen').style.display = 'flex';
        }
    </script>
</body>
</html>
